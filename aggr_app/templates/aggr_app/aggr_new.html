{% extends "aggr_app/base.html" %}
{% block title %}New Aggregate{% endblock %}
{% block head %}
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
<script type="text/javascript">
    // Thanks to Charlie Griefer for this jQuery code.
    // http://charlie.griefer.com/blog/2009/09/17/jquery-dynamically-adding-form-elements/
    
    $(document).ready(function() {
        $('#btnAdd').click(function() {
            var num     = $('.clonedInput').length - 1; // how many "duplicatable" input fields we currently have
            var newNum  = new Number(num + 1);      // the numeric ID of the new input field being added

            // create the new element via clone(), and manipulate its ID using newNum value
            var newElem = $('#input' + num).clone().attr('id', 'input' + newNum);

            // manipulate the name/id values of the input inside the new element
            newElem.children(':eq(0)').attr('id', 'feed' + newNum).attr('name', 'feed' + newNum);
            newElem.children(':eq(1)').attr('id', 'filter' + newNum).attr('name', 'filter' + newNum).attr('value', '')
            newElem.children(':eq(0)').children(':eq(0)').attr('selected', 'selected')

            // insert the new element after the last "duplicatable" input field
            $('#input' + num).after(newElem);

            // enable the "remove" button
            $('#btnDel').attr('disabled','');

            // business rule: you can only add 5 names
            if (newNum == 20)
                $('#btnAdd').attr('disabled','disabled');
        });

        $('#btnDel').click(function() {
            var num = $('.clonedInput').length - 1; // how many "duplicatable" input fields we currently have
            $('#input' + num).remove();     // remove the last element

            // enable the "add" button
            $('#btnAdd').attr('disabled','');

            // if only one element remains, disable the "remove" button
            if (num == 1)
                $('#btnDel').attr('disabled','disabled');
        });

        if ($('.clonedInput').length < 2)
            $('#btnDel').attr('disabled','disabled');
    });
</script>
{% endblock %}
{% block content %}
<h2>New Aggregate</h2>
{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

{% if aggr == None %}
<form action="{% url aggr_app.views.new_aggr %}" method="post">
{% else %}
<form action="{% url aggr_app.views.new_aggr aggr.id %}" method="post">
{% endif %}
{% csrf_token %}
<label for="name">Aggregate Name</label> <input type="text" name="name" id="0" value="{{ aggr.name }}" /><br />
<label>Filters</label>
{% if aggr != None %}
{% for filtered_feed in aggr.feeds.all %}
<div id="input{{ forloop.counter0 }}" class="clonedInput">
    <select name="feed{{ forloop.counter0 }}" id="feed{{ forloop.counter0 }}">
    {% for feed in feed_list %}
        <option value="{{ feed.id }}" {% if feed.id == filtered_feed.feed.id %}selected="selected"{% endif %}>{{ feed.name }}</option>
    {% endfor %}
    </select>
    <input type="text" size="50" name="filter{{ forloop.counter0 }}" id="filter{{ forloop.counter0 }}" value="{{ filtered_feed.re_filter }}" />
</div>
{% endfor %}
{% else %}
<div id="input0" class="clonedInput">
    <select name="feed0" id="feed0">
    {% for feed in feed_list %}
        <option value="{{ feed.id }}">{{ feed.name }}</option>
    {% endfor %}
    </select>
    <input type="text" size="50" name="filter0" id="filter0" />
</div>
{% endif %}
<div>
    <input type="button" id="btnAdd" value="Add Filter" />
    <input type="button" id="btnDel" value="Remove Filter" />
</div>
{% if aggr == None %}
<input type="submit" value="Create Aggregate" />
{% else %}
<input type="submit" value="Save Changes" />
{% endif %}
</form>
{% endblock content %}
